<!doctype html>
<html lang="fi">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta name="description" content="Tarjonta">
        <meta name="author" content="Opetushallitus">
        <title>Tarjonta</title>

        <script src="lib/jquery-1.10.2.min.js"></script>
        <script src="lib/jquery-ui.min.js"></script>

        <!--
          Environment configuration file(s):
          Do not add angular application data to 'ext/*' (or 'ext/js/*' etc.)
          data in the directory will be overridden by tarjontaapp service filter.
        -->
        <script src="ext/js/env-configuration.js"></script>
        <!--
        Application configuration file(s):
        -->
        <script src="js/app-configuration.js"></script>
        <!--
         Developer configuration file(s):
        -->
        <script src="dev/dev-configuration.js"></script>

        <!--
        Angular, see version.txt for version.
        -->
        <script src="lib/angular/angular.js"></script>
        <script src="lib/angular/angular-resource.js"></script>
        <script src="lib/angular/angular-route.js"></script>
        <script src="lib/angular/angular.treeview.js"></script>
        <script src="lib/angular/angular-sanitize.js"></script>

        <script src="lib/ngGrid/ng-grid-2.0.7.debug.js"></script>
        <link href="lib/ngGrid/ng-grid.min.css" rel="stylesheet">

        <script src="lib/underscore/underscore.js"></script>

        <script src="js/shared/auth.js"></script>
        <script src="js/shared/permissions.js"></script>
        <script src="js/shared/cache.js"></script>
        <script src="js/shared/koodisto.js"></script>
        <script src="js/shared/organisaatio.js"></script>
        <script src="js/shared/tarjonta.js"></script>
        <script src="js/shared/yhteyshenkilo.js"></script>
        <script src="js/shared/directives/koodistoNimiCombo.js"></script>
        <script src="js/shared/directives/koodistoArvoCombo.js"></script>
        <script src="js/shared/directives/koodistoMultiSelect.js"></script>
        <script src="js/shared/loading.js"></script>
        <script src="js/shared/localisation.js"></script>
        <script src="js/shared/config.js"></script>
        <script src="js/shared/directives/zippy.js"></script>
        <script src="js/shared/haku.js"></script>
        <script src="js/shared/hakukohde.js"></script>
        <script src="js/shared/directives/ngonce.js"></script>
        <link href="js/shared/directives/zippy.css" rel="stylesheet">

        <script src="partials/controllers.js"></script>
        <script src="partials/directives.js"></script>
        <script src="partials/filters.js"></script>
        <script src="partials/services.js"></script>

        <script src="partials/search/controllers.js"></script>

        <script src="partials/kk/directives.js"></script>
        <script src="partials/kk/edit/controllers.js"></script>
        <script src="partials/kk/edit/selectTutkintoControllers.js"></script>
        <script src="partials/kk/edit/editYhteyshenkiloController.js"></script>
        <script src="partials/kk/review/reviewControllers.js"></script>
        <script src="partials/kk/edit/hakukohde/hakukohdeControllers.js"></script>
        <script src="partials/kk/filters.js"></script>
        <script src="partials/kk/services.js"></script>

        <script src="partials/koulutus/koulutusController.js"></script>

        <script src="partials/helpers/localisationControllers.js"></script>

        <script src="lib/ui-bootstrap-tpls-0.6.0.js"></script>
        <link href="lib/bootstrap-combined.min.css" rel="stylesheet">


        <script src="partials/tarjontaApp.js"></script>

        <link rel="stylesheet" href="css/app.css"/>
        <link rel="stylesheet" href="css/tree.css"/>
    </head>

    <body ng-controller="AppRoutingCtrl">
        <div data-ng-controller="LocalisationCtrl">
            <div ng-switch on="renderPath[0]">
                <div ng-switch-when="home">
                    <div ng-include="'partials/search/search.html'" ng-controller="SearchController"></div>
                </div>
                <div ng-switch-when="kk">
                    <div ng-switch on="renderPath[1]">
                        <div ng-switch-when="hakukohde">
                             <div ng-switch on="renderPath[2]">
                                <div ng-switch-when="create">

                                    <div ng-include="'partials/kk/edit/hakukohde/editHakukohde.html'" ng-controller="HakukohdeEditController"></div>
                                </div>
                            </div>
                        </div>
                        <div ng-switch-when="edit">
                            <div ng-include="'partials/kk/edit/edit.html'" ng-controller="KKEditController"></div>
                        </div>
                        <div ng-switch-when="review">
                            <div ng-include="'partials/kk/review/review.html'" ng-controller="KKReviewController"></div>
                        </div>
                    </div><!-- /renderPath[1] -->
                </div><!-- 0:/kk -->
                <div ng-switch-when="helpers">
                    <div ng-switch on="renderPath[1]">
                        <div ng-switch-when="localisations">
                            <div ng-include="'partials/helpers/localisation.html'" ng-controller="HelpersLocalisationCtrl"></div>
                        </div>
                    </div>
                </div><!-- 0:/helpers -->

                <div ng-switch-when="koulutus">
                    <div ng-switch on="renderPath[1]" ng-controller="KoulutusRoutingController">
                        <div ng-switch-when="review">
                            {{ getKoulutusPartialName("review") }}
                            <div ng-include="getKoulutusPartialName('review')"></div>
                        </div>
                        <div ng-switch-when="edit">
                            {{ getKoulutusPartialName("edit") }}
                            <div ng-include="getKoulutusPartialName('edit')"></div>
                        </div>
                        <div ng-switch-default>
                             UNKNOWN ACTION! {{ renderPath | json }}
                        </div>
                    </div>
                </div><!-- 0:/helpers -->

                <div ng-switch-when="koodistoTest">
                    <div ng-include="'partials/koodistoTest.html'" ng-controller="KoodistoTestController"></div>
                </div>
            </div><!-- /renderPath[0] -->

            <div class="wsidebar-main">
                <hr>
                Footer, route counter = {{count}}<br>
                <a href="#/etusivu">Etusivulle</a>
                <a href="#/helpers/localisations">Käännökset</a>

                <div>
                    <span ng-click="showTheSheisse = !showTheSheisse"
                          class="collapseHeader"
                          ng-class="{isOpen : showTheSheisse}">Näytä Config</span>
                    <div collapse="!showTheSheisse">
                        <pre>
                        {{ CONFIG | json }}
                        </pre>
                    </div>
                </div>
            </div>

            <div data-ng-controller="LoadingCtrl"
                 data-ng-show="loading"
                 id="ajax-loader"
                 class="{{ isModal() ? 'max' : 'min' }}">
                <div>
                    <img alt="{{ t('loading') }}" src="img/ajax-loader-big.gif" />
                    <span>{{ t("loading") }}</span>
                </div>
            </div>
        </div>


        <script>
            var init_counter = 0;
            var initFunction = function(id, xhr, status) {
                init_counter--;

                console.log("Got ready signal from: " + id);
                console.log("  status = ", status);
                console.log("  xhr = ", xhr);

                if (init_counter > 0) {
                    console.log("Got ready signal from: '" + id + "' -- still waiting for " + init_counter + " requests.");
                } else {
                    console.log("OK! That was the last request, init the app!");

                    angular.element(document).ready(function() {
                        angular.module('myApp', ['app']);
                        angular.bootstrap(document, ['myApp']);
                    });
                }
            };


            //
            // Get current users authorisation info (/cas/myroles)
            //
            console.log("** Loading authentication info; from: " + window.CONFIG.env.casUrl);
            init_counter++;
            jQuery.ajax(window.CONFIG.env.casUrl, {
                dataType: "json",
                success: function(xhr, status) {
                    window.CONFIG.env["cas.myroles"] = xhr;
                    initFunction("AUTHENTICATION", xhr, status);
                },
                error: function(xhr, status) {
                    window.CONFIG.env["cas.myroles"] = [];
                    initFunction("AUTHENTICATION FAILED", xhr, status);
                }
            });

            //
            // Preload "tarjonta.tila"???
            //
            console.log("** Loading tarjonta.tila info; from: " + window.CONFIG.env.tarjontaRestUrlPrefix + "tila");
            init_counter++;
            jQuery.ajax(window.CONFIG.env.tarjontaRestUrlPrefix + "tila", {
                dataType: "json",
                success: function(xhr, status) {
                    window.CONFIG.env["tarjonta.tila"] = xhr;
                    initFunction("tarjonta.tila", xhr, status);
                },
                error: function(xhr, status) {
                    window.CONFIG.env["tarjonta.tila"] = {};
                    initFunction("tarjonta.tila FAILED", xhr, status);
                }
            });

            //
            // Preloadt application localisation
            //
            init_counter++;
            jQuery.ajax(window.CONFIG.env.tarjontaRestUrlPrefix + "localisation", {
                dataType: "json",
                complete: function(xhr, status) {
                    window.CONFIG.env["tarjonta.localisations"] = xhr.responseJSON;
                    initFunction("localisations", xhr, status);
                },
                error: function(xhr, status) {
                    window.CONFIG.env["tarjonta.localisations"] = [];
                    initFunction("localisations FAILED", xhr, status);
                }
            });
        </script>

    </body>
</html>
